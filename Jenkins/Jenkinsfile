pipeline {
    agent {
        kubernetes {
          yamlFile 'Jenkins/container-builder.yaml'
        }
      }


    environment{
        SOURCE_REPOSITORY_URL = 'https://github.com/inganyoyo/hello-devops-gradle.git'
        MANIFEST_REPOSITORY_URL = 'https://github.com/inganyoyo/k8s-manifest.git'
        REPOSITORY_BRANCH = 'main'
        GIT_CREDENTIALS_ID = 'git-jenkins-token'
        GIT_MESSAGE = """${sh(
            script: 'git log --no-walk --format=format:%s ${GIT_COMMIT}',
            returnStdout: true
            )}"""
    }
    stages {

            stage ('build project gradle') {
                steps {
                    checkout scm: [
                        $class: 'GitSCM',
                        branches: [[name: '*/master']],
                        userRemoteConfigs: [[url: 'https://[path]/parent.git']],
                        extensions: [[
                            $class: 'PathRestriction', excludedRegions: 'k8s/.*', includedRegions: ''
                        ]]
                    ]

                }
            }

            stage ('build project gradle') {
                steps {
                    sh 'echo "Message: --${GIT_MESSAGE}--"'

                }
            }

//         stage ('build project gradle') {
//             steps {
//                 sh 'echo "Message: --${GIT_MESSAGE}--"'
//                 container('gradle') {
//                     dir ('.'){
//                         sh """
//                         gradle -v
//                         gradle clean build -i
//                         """
//                     }
//                 }
//             }
//         }
//
//         stage('Kaniko Build & Push Image') {
//           steps {
//             container('kaniko') {
//               script {
//                 sh '''
//                 /kaniko/executor --dockerfile `pwd`/Jenkins/Dockerfile \
//                                  --context `pwd` \
//                                  --destination=inganyoyo/hello-devops-springboot:${BUILD_NUMBER}
//                 '''
//               }
//             }
//           }
//         }
//
//         stage('Trigger ManifestUpdate') {
//             steps{
//                 echo "triggering updatemanifestjob"
//                 build job: 'hello-devops-gradle-updatemanifest', parameters: [string(name: 'IMG_TAG', value: env.BUILD_NUMBER),string(name: 'COMMIT_MSG', value: "${GIT_MESSAGE}")]
//             }
//         }



    }
}

